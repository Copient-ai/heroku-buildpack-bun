#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>
# $HOME: /app

set -e

BUILD_DIR=${1:-.}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
BP_DIR=$(cd "$(dirname "${0:-}")"; cd ..; pwd)

### Load dependencies
source "$BP_DIR/lib/json.sh"

HEROKU_DIR=$BUILD_DIR/.heroku
BIN_DIR=$HEROKU_DIR/bin

# To enable the local source build cache path, copy the files and match the build path with the startup path.
cp -rp $BUILD_DIR $HOME
cd $HOME

# Allow Bun version pinning
if [ -f $ENV_DIR/BUN_VERSION ]
then
  BUN_VERSION="$(cat $ENV_DIR/BUN_VERSION)"
elif [ -f $BUILD_DIR/runtime.bun.txt ]
then
  BUN_VERSION="$(cat $BUILD_DIR/runtime.bun.txt)"
elif [ -f $BUILD_DIR/runtime.txt ]
then
  BUN_VERSION="$(cat $BUILD_DIR/runtime.txt)"
fi
echo "Installing Bun $BUN_VERSION"

if [[ -n $BUN_VERSION ]]
then
  BUN_INSTALL_VERSION="-s bun-$BUN_VERSION"
fi

# install bun
export BUN_INSTALL=$BUILD_DIR/.heroku
export BUN_DIR=$BUILD_DIR/.heroku/cache
curl -fsSL https://bun.sh/install | bash $BUN_INSTALL_VERSION
export PATH="$BUN_INSTALL/bin:$PATH"

# set environment variables
PROFILE_PATH="$BUILD_DIR/.profile.d/bun.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$HOME/.heroku/bin:$PATH"' >> $PROFILE_PATH
echo 'export BUN_DIR="$HOME/.heroku/cache"' >> $PROFILE_PATH

echo "Installed Bun v$(bun --version)"

set +e

cd $BUILD_DIR

# download dependencies
if [ -f package.json ]
then
  echo "Installing dependencies..."
  bun install
fi

has_heroku_prebuild_script=$(has_script "package.json" "heroku-prebuild")
if [[ "$has_heroku_prebuild_script" == "true" ]]
then
  echo "Running Heroku prebuild script..."
  bun run heroku-prebuild
fi

has_build_script=$(has_script "package.json" "build")
if [[ "$has_build_script" == "true" ]]
then
  echo "Building application..."
  bun run build
  echo "Done building application..."
fi

has_heroku_postbuild_script=$(has_script "package.json" "heroku-postbuild")
if [[ "$has_heroku_postbuild_script" == "true" ]]
then
  echo "Running Heroku postbuild script..."
  bun run heroku-postbuild
fi
